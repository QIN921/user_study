<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <title>用户研究：请选择您的偏好</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; background: #f7f7f7; }
  h2 { color: #333; }
  p { line-height: 1.6; }
  video { width: 33%; margin: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .video-row { display: flex; justify-content: center; align-items: center; }
    .video-status { font-size: 13px; color: #b45309; margin-top: 6px; width: 33%; text-align: center; }
    .buttons { margin-top: 20px; }
    button {
      margin: 5px; padding: 10px 20px; border: none; border-radius: 6px;
      background-color: #007BFF; color: white; font-size: 16px; cursor: pointer;
    }
    .buttons br { display: block; margin: 10px 0; }
    #status { color: green; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>用户研究：请选择您的偏好</h2>
  <p>
     请比较下面的视频，并根据感知质量、时间连续性以及与原始视频的相似性选择您的偏好。<br>
     <b>第一排视频始终为原始视频。</b> 第二排以随机顺序显示方法 A 和方法 B。<br>
  </p>

  <!-- 视频 -->
  <div class="video-row">
    <div class="video-status" id="status-gt" aria-live="polite"></div>
    <video id="gt" controls></video>
    <div class="video-status" id="status-gt" aria-live="polite"></div>
  </div>
  <div class="video-row">
    <div class="video-status" id="status-left" aria-live="polite"></div>
    <video id="left" controls></video>
    <video id="right" controls></video>
    <div class="video-status" id="status-right" aria-live="polite"></div>
  </div>

  <!-- 按钮 -->
  <div class="buttons">
    <button onclick="setPreference('Left')">选择左侧</button>
    <button onclick="setPreference('Neutral')">中立</button>
    <button onclick="setPreference('Right')">选择右侧</button>
    <br>
    <button onclick="saveAndNext()">保存并下一题</button>
    <button onclick="exportCSV()">全部结束后导出结果</button>
  </div>

  <p id="status"></p>
  <p id="trialInfo"></p>

  <script>
    // === 实验组定义 ===
    const trials = [
      { id: 1, gt: 'video/Kimono1_1920x1080_24/GT.mp4', A: 'video/Kimono1_1920x1080_24/Ours.mp4', B: 'video/Kimono1_1920x1080_24/DCVC_RT.mp4' },
      { id: 2, gt: 'video/Kimono1_1920x1080_24/GT.mp4', A: 'video/Kimono1_1920x1080_24/Ours.mp4', B: 'video/Kimono1_1920x1080_24/DCVC_RT_2.mp4' },
      { id: 3, gt: 'video/Kimono1_1920x1080_24/GT.mp4', A: 'video/Kimono1_1920x1080_24/Ours.mp4', B: 'video/Kimono1_1920x1080_24/VVC.mp4' },
      { id: 4, gt: 'video/BasketballDrill_832x480_50/GT.mp4', A: 'video/BasketballDrill_832x480_50/Ours.mp4', B: 'video/BasketballDrill_832x480_50/DCVC_RT.mp4' },
      { id: 5, gt: 'video/BasketballDrill_832x480_50/GT.mp4', A: 'video/BasketballDrill_832x480_50/Ours.mp4', B: 'video/BasketballDrill_832x480_50/DCVC_RT_2.mp4' },
      { id: 6, gt: 'video/BasketballDrill_832x480_50/GT.mp4', A: 'video/BasketballDrill_832x480_50/Ours.mp4', B: 'video/BasketballDrill_832x480_50/VVC.mp4' },
      { id: 7, gt: 'video/Johnny_1280x720_60/GT.mp4', A: 'video/Johnny_1280x720_60/Ours.mp4', B: 'video/Johnny_1280x720_60/DCVC_RT.mp4' },
      { id: 8, gt: 'video/Johnny_1280x720_60/GT.mp4', A: 'video/Johnny_1280x720_60/Ours.mp4', B: 'video/Johnny_1280x720_60/DCVC_RT_2.mp4' },
      { id: 9, gt: 'video/Johnny_1280x720_60/GT.mp4', A: 'video/Johnny_1280x720_60/Ours.mp4', B: 'video/Johnny_1280x720_60/VVC.mp4' },
      { id: 10, gt: 'video/KristenAndSara_1280x720_60/GT.mp4', A: 'video/KristenAndSara_1280x720_60/Ours.mp4', B: 'video/KristenAndSara_1280x720_60/DCVC_RT.mp4' },
      { id: 11, gt: 'video/KristenAndSara_1280x720_60/GT.mp4', A: 'video/KristenAndSara_1280x720_60/Ours.mp4', B: 'video/KristenAndSara_1280x720_60/DCVC_RT_2.mp4' },
      { id: 12, gt: 'video/KristenAndSara_1280x720_60/GT.mp4', A: 'video/KristenAndSara_1280x720_60/Ours.mp4', B: 'video/KristenAndSara_1280x720_60/VVC.mp4' },
      { id: 13, gt: 'video/BQSqure_416x240_60/GT.mp4', A: 'video/BQSqure_416x240_60/Ours.mp4', B: 'video/BQSqure_416x240_60/DCVC_RT.mp4' },
      { id: 14, gt: 'video/BQSqure_416x240_60/GT.mp4', A: 'video/BQSqure_416x240_60/Ours.mp4', B: 'video/BQSqure_416x240_60/DCVC_RT_2.mp4' },
      { id: 15, gt: 'video/BQSqure_416x240_60/GT.mp4', A: 'video/BQSqure_416x240_60/Ours.mp4', B: 'video/BQSqure_416x240_60/VVC.mp4' },
      { id: 16, gt: 'video/videoSRC11_1920x1080_30/GT.mp4', A: 'video/videoSRC11_1920x1080_30/Ours.mp4', B: 'video/videoSRC11_1920x1080_30/DCVC_RT.mp4' },
      { id: 17, gt: 'video/videoSRC11_1920x1080_30/GT.mp4', A: 'video/videoSRC11_1920x1080_30/Ours.mp4', B: 'video/videoSRC11_1920x1080_30/DCVC_RT_2.mp4' },
      { id: 18, gt: 'video/videoSRC11_1920x1080_30/GT.mp4', A: 'video/videoSRC11_1920x1080_30/Ours.mp4', B: 'video/videoSRC11_1920x1080_30/VVC.mp4' },
      { id: 19, gt: 'video/Bosphorus_1920x1080_120/GT.mp4', A: 'video/Bosphorus_1920x1080_120/Ours.mp4', B: 'video/Bosphorus_1920x1080_120/DCVC_RT.mp4' },
      { id: 20, gt: 'video/Bosphorus_1920x1080_120/GT.mp4', A: 'video/Bosphorus_1920x1080_120/Ours.mp4', B: 'video/Bosphorus_1920x1080_120/DCVC_RT_2.mp4' },
      { id: 21, gt: 'video/Bosphorus_1920x1080_120/GT.mp4', A: 'video/Bosphorus_1920x1080_120/Ours.mp4', B: 'video/Bosphorus_1920x1080_120/VVC.mp4' },
      { id: 22, gt: 'video/YatchtRide_1920x1080_120/GT.mp4', A: 'video/YatchtRide_1920x1080_120/Ours.mp4', B: 'video/YatchtRide_1920x1080_120/DCVC_RT.mp4' },
      { id: 23, gt: 'video/YatchtRide_1920x1080_120/GT.mp4', A: 'video/YatchtRide_1920x1080_120/Ours.mp4', B: 'video/YatchtRide_1920x1080_120/DCVC_RT_2.mp4' },
      { id: 24, gt: 'video/YatchtRide_1920x1080_120/GT.mp4', A: 'video/YatchtRide_1920x1080_120/Ours.mp4', B: 'video/YatchtRide_1920x1080_120/VVC.mp4' },
      // ... 添加更多
    ];

    // === 打乱Trial顺序 ===
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // === 如果超过25个，则随机选取25个 ===
    let selectedTrials = trials;
    if (trials.length > 25) {
      selectedTrials = shuffle([...trials]).slice(0, 25);
    }

    // === 最终随机顺序 ===
    const randomizedTrials = shuffle([...selectedTrials]);

    let current = 0;
    let preference = null;
    let results = [];

    const gtVideo = document.getElementById('gt');
    const leftVideo = document.getElementById('left');
    const rightVideo = document.getElementById('right');
    const status = document.getElementById('status');
    const trialInfo = document.getElementById('trialInfo');
    const videos = [gtVideo, leftVideo, rightVideo];

    // === 轻度阻止查看源码的客户端脚本（只作抑制，无法真正隐藏HTML） ===
    (function installBasicDevtoolsDeterrent(){
      // 禁用右键菜单
      document.addEventListener('contextmenu', function(e){
        e.preventDefault();
      });

      // 禁用常见快捷键（F12、Ctrl+Shift+I/C/J、Ctrl+U 等）
      document.addEventListener('keydown', function(e){
        // F12
        if (e.keyCode === 123) {
          e.preventDefault();
          return false;
        }
        // Ctrl+Shift+I / Ctrl+Shift+C / Ctrl+Shift+J
        if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'C' || e.key === 'c' || e.key === 'J' || e.key === 'j')) {
          e.preventDefault();
          return false;
        }
        // Ctrl+U (查看源代码)
        if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
          e.preventDefault();
          return false;
        }
        // Ctrl+S / Ctrl+P / Ctrl+Shift+S 常见保存/打印，阻止以避免下载源码片段
        if (e.ctrlKey && (e.key === 's' || e.key === 'S' || e.key === 'p' || e.key === 'P')) {
          e.preventDefault();
          return false;
        }
      }, false);
    })();

    // === 视频加载错误时的重试机制 (无限重试，带退避) ===
    function setupVideoRetry(v) {
      // 使用 dataset 存储状态
      v.dataset.retryCount = 0;
      v.dataset.retryTimer = '';

      function clearRetryTimer() {
        if (v.dataset.retryTimer) {
          try { clearTimeout(Number(v.dataset.retryTimer)); } catch (e) {}
          v.dataset.retryTimer = '';
        }
      }

      v.addEventListener('error', () => {
        // 增加重试计数
        v.dataset.retryCount = Number(v.dataset.retryCount || 0) + 1;
        const count = Number(v.dataset.retryCount);
        // 指数退避：从2s开始，最多30s
        const delay = Math.min(Math.round(2000 * Math.pow(1.5, count - 1)), 30000);

          const name = v.dataset && v.dataset.filename ? v.dataset.filename : v.id;
          const statusEl = document.getElementById(`status-${v.id}`) || status;
          statusEl.textContent = `⚠️ 视频 "${name}" 加载失败，正在尝试重试（第 ${count} 次，间隔 ${Math.round(delay/1000)}s）...`;

        clearRetryTimer();
        const t = setTimeout(() => {
          try {
            // 触发重新加载：重新设置 src 然后 load()
            const src = v.getAttribute('src') || v.currentSrc || v.src;
            if (src) {
              // 先清空然后重设可以触发浏览器重新请求
              v.src = '';
              void v.offsetWidth; // 强制回流（微妙技巧）
              v.src = src;
              v.load();
            }
          } catch (e) {
            // ignore
          }
        }, delay);
        v.dataset.retryTimer = String(t);
      });

      v.addEventListener('loadeddata', () => {
        // 成功加载，清除计时器和提示
        clearRetryTimer();
        v.dataset.retryCount = 0;
        const statusEl = document.getElementById(`status-${v.id}`) || status;
        statusEl.textContent = '';
      });
    }

    // 为所有三个 video 设置重试机制
    videos.forEach(v => setupVideoRetry(v));

    // === 同步播放 ===
    videos.forEach(v => {
      v.addEventListener('play', () => videos.forEach(x => { if (x !== v) x.play(); }));
      v.addEventListener('pause', () => videos.forEach(x => { if (x !== v) x.pause(); }));
      v.addEventListener('seeked', () => {
        const t = v.currentTime;
        videos.forEach(x => { if (Math.abs(x.currentTime - t) > 0.2) x.currentTime = t; });
      });
    });

    // === 载入Trial ===
    function loadTrial() {
      if (current >= randomizedTrials.length) {
        status.textContent = "✅ 所有试验已完成。现在可以导出结果。";
        trialInfo.textContent = "";
        gtVideo.src = ""; leftVideo.src = ""; rightVideo.src = "";
        // 清理各视频的状态提示
        const sgt = document.getElementById('status-gt');
        const sleft = document.getElementById('status-left');
        const sright = document.getElementById('status-right');
        if (sgt) sgt.textContent = '';
        if (sleft) sleft.textContent = '';
        if (sright) sright.textContent = '';
        return;
      }

      const t = randomizedTrials[current];
      const swap = Math.random() < 0.5;
      const leftSrc = swap ? t.A : t.B;
      const rightSrc = swap ? t.B : t.A;

      gtVideo.src = t.gt;
      leftVideo.src = leftSrc;
      rightVideo.src = rightSrc;

  // 清理本次 trial 的各视频状态提示
  const sgt = document.getElementById('status-gt');
  const sleft = document.getElementById('status-left');
  const sright = document.getElementById('status-right');
  if (sgt) sgt.textContent = '';
  if (sleft) sleft.textContent = '';
  if (sright) sright.textContent = '';

      leftVideo.dataset.filename = leftSrc.split('/').pop().replace('.mp4', '');
      rightVideo.dataset.filename = rightSrc.split('/').pop().replace('.mp4', '');

      preference = null;
      status.textContent = "";
        trialInfo.textContent = `试验 ${current + 1} / ${randomizedTrials.length}`;
    }

    function setPreference(choice) {
      preference = choice;
      status.textContent = "已选择偏好：" + choice;
    }

    // === 文件名映射到字母 (用于CSV) ===
    function mapFilenameToLetter(name) {
      // 一般 name 示例: 'Ours', 'DCVC_RT', 'DCVC_RT_2', 'VVC'
      if (!name) return name;
      switch (name) {
        case 'Ours':
          return 'A';
        case 'DCVC_RT':
          return 'B';
        case 'DCVC_RT_2':
          return 'C';
        case 'VVC':
          return 'D';
        default:
          return name; // 保留原值以防有其它命名
      }
    }

    // === 保存 + 下一组 ===
    function saveAndNext() {
      if (!preference) {
        alert("⚠️ 请在继续前选择您的偏好。");
        return;
      }

      const t = randomizedTrials[current];
      // 原始文件名
      let rawChosen;
      if (preference === 'Neutral') {
        rawChosen = 'Neutral';
      } else if (preference === 'Left') {
        rawChosen = leftVideo.dataset.filename;
      } else {
        rawChosen = rightVideo.dataset.filename;
      }

      // 映射为字母（或保留 Neutral）
      const leftMapped = mapFilenameToLetter(leftVideo.dataset.filename);
      const rightMapped = mapFilenameToLetter(rightVideo.dataset.filename);
      const choiceMapped = rawChosen === 'Neutral' ? 'Neutral' : mapFilenameToLetter(rawChosen);

      results.push({
        trialOrder: current + 1,
        originalID: t.id,
        GT: t.gt.split('/').slice(-2, -1)[0],  // e.g., "BasketballDrill_832x480_50"
        leftVideo: leftMapped,
        rightVideo: rightMapped,
        choice: choiceMapped,
        timestamp: new Date().toISOString()
      });

      current++;
      loadTrial();
    }

    // === 导出CSV ===
    function exportCSV() {
      if (results.length === 0) {
        alert("没有可导出的结果。");
        return;
      }
      const csv = "试验序号,原始ID,视频组,左视频,右视频,选择,时间戳\n" +
        results.map(r => `${r.trialOrder},${r.originalID},${r.GT},${r.leftVideo},${r.rightVideo},${r.choice},${r.timestamp}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "用户研究结果.csv";
      a.click();
    }

    // === 初始化 ===
    loadTrial();
  </script>

</body>
</html>
